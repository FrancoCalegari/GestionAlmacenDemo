<%- include('../partials/header') %>

<div
	style="
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
	"
>
	<h1 style="font-size: 2rem; font-weight: 700">Inventario</h1>
	<a href="/warehouse" class="btn" style="background: var(--bg-accent)"
		><i class="fa-solid fa-arrow-left"></i> Volver</a
	>
</div>

<div style="display: grid; grid-template-columns: 3fr 1fr; gap: 2rem">
	<!-- Inventory List -->
	<div class="glass-card">
		<div
			style="display: flex; justify-content: space-between; margin-bottom: 1rem"
		>
			<input
				type="text"
				id="search"
				placeholder="Buscar producto..."
				class="form-control"
				style="max-width: 300px"
				onkeyup="filterTable()"
			/>
		</div>

		<div style="overflow-x: auto">
			<table class="table" style="width: 100%; border-collapse: collapse">
				<thead>
					<tr
						style="
							text-align: left;
							border-bottom: 1px solid var(--border-color);
						"
					>
						<th style="padding: 1rem">SKU</th>
						<th style="padding: 1rem">Producto</th>
						<th style="padding: 1rem">Stock</th>
						<th style="padding: 1rem">Acciones</th>
					</tr>
				</thead>
				<tbody id="inventory-body">
					<% products.forEach(p => { %>
					<tr
						style="border-bottom: 1px solid var(--glass-border)"
						class="product-row"
					>
						<td style="padding: 1rem; color: var(--text-secondary)">
							<%= p.sku %>
						</td>
						<td style="padding: 1rem; font-weight: 500"><%= p.name %></td>
						<td style="padding: 1rem">
							<span
								style="font-weight: 700; color: <%= p.stock <= p.min_stock ? 'var(--danger)' : 'var(--success)' %>"
							>
								<%= p.stock %>
							</span>
						</td>
						<td style="padding: 1rem">
							<button
								onclick="openRestockModal('<%= p.id %>', '<%= p.name %>', <%= p.stock %>)"
								class="btn"
								style="
									background: var(--bg-accent);
									padding: 0.5rem;
									font-size: 0.8rem;
								"
							>
								<i class="fa-solid fa-plus"></i> Stock
							</button>
						</td>
					</tr>
					<% }) %>
				</tbody>
			</table>
		</div>
	</div>

	<!-- Add Product Form -->
	<div class="glass-card">
		<h3 style="margin-bottom: 1.5rem">Nuevo Producto</h3>
		<form action="/warehouse/products" method="POST">
			<div class="form-group">
				<label class="form-label">Nombre</label>
				<input type="text" name="name" class="form-control" required />
			</div>
			<div class="form-group">
				<label class="form-label">SKU</label>
				<input type="text" name="sku" class="form-control" required />
			</div>
			<div class="form-group">
				<label class="form-label">Categor√≠a</label>
				<input type="text" name="category" class="form-control" />
			</div>
			<div class="form-group">
				<label class="form-label">Precio</label>
				<input
					type="number"
					step="0.01"
					name="price"
					class="form-control"
					required
				/>
			</div>
			<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
				<div class="form-group">
					<label class="form-label">Stock Inicial</label>
					<input type="number" name="stock" class="form-control" required />
				</div>
				<div class="form-group">
					<label class="form-label">Min Stock</label>
					<input
						type="number"
						name="min_stock"
						class="form-control"
						value="5"
					/>
				</div>
			</div>
			<button type="submit" class="btn btn-primary" style="width: 100%">
				Crear
			</button>
		</form>
	</div>
</div>

<!-- Restock Modal -->
<div
	id="restock-modal"
	style="
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.7);
		align-items: center;
		justify-content: center;
		z-index: 1000;
		backdrop-filter: blur(5px);
	"
>
	<div
		class="glass-card"
		style="width: 100%; max-width: 400px; background: var(--bg-secondary)"
	>
		<h3 style="margin-bottom: 1rem">Reponer Stock</h3>
		<p
			id="restock-product-name"
			style="color: var(--text-secondary); margin-bottom: 1.5rem"
		></p>

		<form action="/warehouse/restock" method="POST">
			<input type="hidden" name="id" id="restock-id" />
			<div class="form-group">
				<label class="form-label">Cantidad a Agregar</label>
				<input
					type="number"
					name="quantity"
					class="form-control"
					required
					min="1"
					autofocus
				/>
			</div>
			<div style="display: flex; gap: 1rem; justify-content: flex-end">
				<button
					type="button"
					class="btn"
					style="background: var(--danger)"
					onclick="closeRestockModal()"
				>
					Cancelar
				</button>
				<button type="submit" class="btn btn-primary">Guardar</button>
			</div>
		</form>
	</div>
</div>

<script>
	function filterTable() {
		const query = document.getElementById("search").value.toLowerCase();
		const rows = document.querySelectorAll(".product-row");
		rows.forEach((row) => {
			const text = row.innerText.toLowerCase();
			row.style.display = text.includes(query) ? "" : "none";
		});
	}

	function openRestockModal(id, name, currentStock) {
		document.getElementById("restock-id").value = id;
		document.getElementById(
			"restock-product-name"
		).textContent = `${name} (Actual: ${currentStock})`;
		document.getElementById("restock-modal").style.display = "flex";
	}

	function closeRestockModal() {
		document.getElementById("restock-modal").style.display = "none";
	}
</script>

<%- include('../partials/footer') %>
