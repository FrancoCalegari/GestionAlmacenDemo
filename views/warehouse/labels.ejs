<%- include('../partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
	@media print {
		@page {
			size: auto;
			margin: 0;
		}
		body * {
			visibility: hidden;
		}
		#print-area,
		#print-area * {
			visibility: visible;
		}
		#print-area {
			position: absolute;
			left: 0;
			top: 0;
			width: 100%;
		}
		.label-card {
			border: 1px solid #000;
			color: #000;
			break-inside: avoid;
		}
	}
	.label-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
		gap: 1rem;
	}
	.label-card {
		background: #fff;
		color: #000;
		padding: 0.5rem;
		text-align: center;
		border-radius: 4px;
	}
</style>

<div class="no-print">
	<div
		style="
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 2rem;
		"
	>
		<h1 style="font-size: 2rem; font-weight: 700">Imprimir Etiquetas</h1>
		<a href="/warehouse" class="btn" style="background: var(--bg-accent)"
			><i class="fa-solid fa-arrow-left"></i> Volver</a
		>
	</div>

	<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem">
		<!-- Selector -->
		<div class="glass-card">
			<h3 style="margin-bottom: 1rem">Configuraci贸n</h3>

			<div class="form-group">
				<label class="form-label">Producto</label>
				<select
					id="product-select"
					class="form-control"
					style="background: var(--bg-primary); color: #fff"
				>
					<% products.forEach(p => { %>
					<option
						value="<%= p.sku %>"
						data-name="<%= p.name %>"
						data-price="<%= p.price %>"
					>
						<%= p.name %>
					</option>
					<% }) %>
				</select>
			</div>

			<div class="form-group">
				<label class="form-label">Tipo de C贸digo</label>
				<select
					id="code-type"
					class="form-control"
					style="background: var(--bg-primary); color: #fff"
				>
					<option value="barcode">C贸digo de Barras</option>
					<option value="qr">C贸digo QR</option>
				</select>
			</div>

			<div class="form-group">
				<label class="form-label">Cantidad</label>
				<input
					type="number"
					id="quantity"
					class="form-control"
					value="1"
					min="1"
				/>
			</div>

			<button onclick="addLabels()" class="btn btn-primary" style="width: 100%">
				Generar
			</button>
			<button
				onclick="window.print()"
				class="btn"
				style="width: 100%; margin-top: 1rem; background: var(--success)"
			>
				<i class="fa-solid fa-print"></i> Imprimir
			</button>
			<button
				onclick="clearLabels()"
				class="btn"
				style="width: 100%; margin-top: 1rem; background: var(--danger)"
			>
				Limpiar
			</button>
		</div>

		<!-- Preview Area -->
		<div class="glass-card">
			<h3 style="margin-bottom: 1rem">Vista Previa</h3>
			<div id="print-area" class="label-grid"></div>
		</div>
	</div>
</div>

<script>
	function addLabels() {
		const select = document.getElementById("product-select");
		const option = select.options[select.selectedIndex];
		const sku = select.value;
		const name = option.dataset.name;
		const price = option.dataset.price;
		const type = document.getElementById("code-type").value;
		const qty = parseInt(document.getElementById("quantity").value);
		const container = document.getElementById("print-area");

		for (let i = 0; i < qty; i++) {
			const div = document.createElement("div");
			div.className = "label-card";

			const id = "code-" + Date.now() + "-" + i;

			let codeHtml = "";
			if (type === "barcode") {
				codeHtml = `<svg id="${id}"></svg>`;
			} else {
				codeHtml = `<div id="${id}" style="display:flex;justify-content:center;margin:5px 0;"></div>`;
			}

			div.innerHTML = `
                <div style="font-weight:bold; font-size: 12px; margin-bottom: 2px;">${name}</div>
                ${codeHtml}
                <div style="font-weight:bold; font-size: 14px;">$${price}</div>
            `;

			container.appendChild(div);

			if (type === "barcode") {
				JsBarcode("#" + id, sku, {
					format: "CODE128",
					width: 1.5,
					height: 40,
					displayValue: true,
				});
			} else {
				new QRCode(document.getElementById(id), {
					text: sku,
					width: 64,
					height: 64,
				});
			}
		}
	}

	function clearLabels() {
		document.getElementById("print-area").innerHTML = "";
	}
</script>

<%- include('../partials/footer') %>
